name: Verify Contracts

on:
  schedule:
    - cron: "0 3 * * *"  # Nightly at 03:00 UTC
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  verify:
    name: Verify Contract Bytecode
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-verify-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-verify-

      - name: Install Soroban CLI
        run: cargo install --locked soroban-cli || true

      - name: Build contracts from source
        working-directory: crates/contracts
        run: cargo build --release --target wasm32-unknown-unknown

      - name: Optimize WASM
        run: soroban contract optimize --wasm crates/contracts/target/wasm32-unknown-unknown/release/stellarroute_contracts.wasm || true

      - name: Compute local WASM hash
        id: local
        run: |
          WASM_FILE="crates/contracts/target/wasm32-unknown-unknown/release/stellarroute_contracts.wasm"
          HASH=$(sha256sum "$WASM_FILE" | awk '{print $1}')
          SIZE=$(stat -c%s "$WASM_FILE" 2>/dev/null || stat -f%z "$WASM_FILE" 2>/dev/null || echo "unknown")
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Fetch deployed contract bytecode
        id: deployed
        if: ${{ vars.SOROBAN_CONTRACT_ID != '' }}
        run: |
          soroban network add testnet \
            --rpc-url "https://soroban-testnet.stellar.org:443" \
            --network-passphrase "Test SDF Network ; September 2015" || true
          if soroban contract fetch \
              --id "${{ vars.SOROBAN_CONTRACT_ID }}" \
              --network testnet \
              --output-file /tmp/deployed.wasm 2>/dev/null; then
            HASH=$(sha256sum /tmp/deployed.wasm | awk '{print $1}')
            echo "hash=$HASH" >> $GITHUB_OUTPUT
            echo "fetched=true" >> $GITHUB_OUTPUT
          else
            echo "fetched=false" >> $GITHUB_OUTPUT
          fi

      - name: Compare bytecodes
        if: ${{ steps.deployed.outputs.fetched == 'true' }}
        run: |
          LOCAL="${{ steps.local.outputs.hash }}"
          DEPLOYED="${{ steps.deployed.outputs.hash }}"
          if [[ "$LOCAL" == "$DEPLOYED" ]]; then
            echo "MATCH: Local and deployed bytecodes are identical."
            echo "RESULT=MATCH" >> $GITHUB_ENV
          else
            echo "MISMATCH: Local=$LOCAL Deployed=$DEPLOYED"
            echo "RESULT=MISMATCH" >> $GITHUB_ENV
            exit 1
          fi

      - name: Verify contract state
        if: ${{ vars.SOROBAN_CONTRACT_ID != '' && steps.deployed.outputs.fetched == 'true' }}
        run: |
          CID="${{ vars.SOROBAN_CONTRACT_ID }}"
          echo "Querying contract state..."
          soroban contract invoke --id "$CID" --network testnet -- version 2>/dev/null || echo "version: N/A"
          soroban contract invoke --id "$CID" --network testnet -- is_paused 2>/dev/null || echo "is_paused: N/A"
          soroban contract invoke --id "$CID" --network testnet -- get_pool_count 2>/dev/null || echo "get_pool_count: N/A"

      - name: Verification summary
        if: always()
        run: |
          echo "## Contract Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Date** | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Local WASM Hash** | \`${{ steps.local.outputs.hash }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Local WASM Size** | ${{ steps.local.outputs.size }} bytes |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.deployed.outputs.fetched }}" == "true" ]]; then
            echo "| **Deployed WASM Hash** | \`${{ steps.deployed.outputs.hash }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Result** | **${RESULT:-SKIPPED}** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **On-chain verification** | Skipped (no contract ID configured) |" >> $GITHUB_STEP_SUMMARY
          fi
